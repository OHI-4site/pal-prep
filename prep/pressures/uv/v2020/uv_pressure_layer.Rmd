---
title: 'OHI+ Palmyra 2020: UV Radiation Pressure'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    toc_depth: 1 
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
     in_header: '../../../src/templates/ohi_hdr.html' 
  pdf_document:
    toc: true
---

# Summary 

The Ultraviolet Radiation pressure layer is generated from daily data on Local Noon Erythemal UV Irradiance (mW/m2) derived from satellite observations. 

For the global OHI assessment, the raw data is processed into anomaly products. The data product of that process are rasters of total number of weekly anomalies per year. An anomaly is defined as greater than the mean climatology plus 1 standard deviation for that cell across the entire dataset (2005-2016).

This script takes the global anomaly rasters and crops them to Palmyra. This time we have decided to use a reference point that represents a regime shift. Once a given cell is anomalous for more than 50% of a five-year period, it has shifted into a new regime. All cells that have a value greater than 130 weeks (51% of a 5 year time period) are assigned a 1. The rest of the cells are scaled to this reference point by dividing by 130.  

# Data

Citation: The Ultraviolet Radiation pressures layer uses the [Aura OMI GLobal Surface UVB Data Product](https://disc.gsfc.nasa.gov/uui/datasets/OMUVBG_V003/summary#).  

**Native Data Resolution**: 0.25 degrees  
**Values**: OMI/Aura Surface UVB Irradiance and Erythemal Dose Daily L2 Global Gridded 0.25 degree x 0.25 degree V3  
**Time Range**: Daily data from 2005 - 2016  
**Format**: HDF5

# Setup 

```{r setup, message = F, warning = F}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(doParallel)
library(foreach)
library(rworldmap)
library(raster)
library(here)

# Source and set file paths
source(here('src/R/common.R'))

dir_prs   <- '~/github/pal-prep/prep/pressures/uv/v2020'
```

# Methods

## Get Global Data

We will use the global data that was processed for OHI Global 2020, which includes data from 2005 - 2019. This data is saved on a server at NCEAS.   

```{r get-global-uv-data, eval=F}

anom_files <- list.files(file.path(glb_anx, 'prs_uv/v2020/int/annual_anomalies_diff'),
                         pattern = "annual_pos",
                         full.names = T)

# Get world map and plot the most recent year of data:
world = getMap()

plot(raster(anom_files[15]), col=cols, main = "UV Radiation Anomalies 2019", box=F, axes=F,
     legend.args=list(text='Anomalous Weeks', side=4, font=2, line=2.5, cex=0.8))
plot(world, col='black', add=T)
```
## Crop to Palmyra

Using the `crop` function from the `raster` package we crop all uv rasters to the Palmyra extent and then reproject them to the US Albers projection for consistency across the assessment. We crop the global rasters first to reduce the time it takes to reproject the rasters. `ocean_ras_50nm` is used as a mask to remove land cells from the raster for better visuals.  


```{r crop-to-pal, eval=F}
registerDoParallel(10) # Register 10 cores for parallel processing

foreach(f = anom_files) %dopar% {
  #f = anom_files[15]
  
  if(!file.exists(paste0(dir_anx,'data_prep/prs_uv/output/uv_annual_anoms/1_new_annual_anom_',
                         substr(basename(f), 22, 25),'.tif'))) {
  raster(f)%>%
    projectRaster(ocean_ras_50nm, method = 'ngb')%>%
    crop(azim_ext)%>%  #the Tetiaroa region in wgs projection
    mask(tet_ocean_rast_100, filename = paste0(dir_anx, '/prs_uv/output/uv_annual_anoms/annual_anom_', substr(basename(f), 22, 25),'.tif'),overwrite=T)
  }else{
    message("Raster exists")
  }
}



f = anom_files[15]
  
 test <-  raster(f) %>%
  projectRaster(ocean_rast50_100, method = 'ngb') %>% 
  crop(usalb_ext50) 
    
plot(raster(file.path(dir_anx, 'prs_uv/output/uv_annual_anoms/annual_anom_2007.tif')), col=cols, 
     main = "Ultraviolet Radiation 2016", legend.args=list(text='Anomalous Weeks', side=4, font=2, line=2.5, cex=0.8))
  
plot(wgs_ext)
plot(tet_ocean_rast_100)
plot(test)
```