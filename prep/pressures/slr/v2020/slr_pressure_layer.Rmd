---
title: 'OHI+ Palmyra 2020: Sea Level Rise Pressure Layer'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    toc_depth: 2 
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
     in_header: '../../../src/templates/ohi_hdr.html' 
  pdf_document:
    toc: true
---

# Summary 

The sea level rise (SLR) pressure layer for Palmyra is derived from a global raster of monthly data indicating mean sea level anomalies from 1993 to 2019. This preparation script does the following for newly available global SLR data:
  
- Clips all monthly rasters to the coast using a 3 nautical mile offshore buffer
- Calculates annual mean sea level anomaly rasters from monthly data
- Rescales values from 0 to 1 using the reference point (maximum annual anomaly across the time series)
- Sets to zero all negative values, indicating decreases in mean sea level
- Resamples raster to ~ 1km^2^ and reprojects to US Albers projection

This process is completed entirely within this script. The raw data is downloaded externally and held on a server at NCEAS. Although the raw data is not provided, this script can be used on the data downloaded from Aviso [here](https://www.aviso.altimetry.fr/data/products/sea-surface-height-products/global/gridded-sea-level-anomalies-mean-and-climatology.html). You will need to register with Aviso in order to get a username and password for data access.

***

# Data

The source data are monthly mean sea level anomalies, in meters. These anomalies are calculated by subtracting the current absolute sea level for each month from the average sea level for that month calculated from 1993 - 2019.

**Reference**: AVISO [Monthly mean Maps of Sea Level Anomaly](https://www.aviso.altimetry.fr/data/products/sea-surface-height-products/global/gridded-sea-level-anomalies-mean-and-climatology.html)

**Downloaded**: 

**Description**: Monthly mean sea level anomaly (meters above mean sea level)

**Native data resolution**: 0.25 degree grid cells

**Time range**: January 1993 - 20??, monthly data provided for each year

**Format**: NetCDF

***

# Setup 

```{r setup, message = F, warning = F}

knitr::opts_chunk$set(fig.width = 10, fig.height = 8, fig.path = 'figs/', message = FALSE, warning = FALSE)

library(raster)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(googleVis)
library(foreach)
library(doParallel)
library(fasterize)
library(rasterVis)
library(animation)
library(here)

# Source and set file paths
source(here('src/R/common.R'))

dir_prs <- '~/github/pal-prep/prep/pressures/slr/v2020'

```

***

# Methods

## Load in SLR data files

We don't need to download the data from the AVISO website because it's already been downloaded for the most recent year of global. So we can just grab the NetCDF files from the global folder.

```{r read-files, eval=F}

## d2016/msla_monthly_mean has data for 1993-2015
## Then include list.files for d2017 through the data folder for current scenario year
slr_nc_files <- c(list.files(file.path(dir_M, "git-annex/globalprep/_raw_data/AVISO_slr/d2020"),
                       full.names = TRUE, pattern = ".nc"),
              list.files(file.path(dir_M, "git-annex/globalprep/_raw_data/AVISO_slr/d2019"),
                       full.names = TRUE, pattern = ".nc"),
              list.files(file.path(dir_M, "git-annex/globalprep/_raw_data/AVISO_slr/d2018"),
                       full.names = TRUE, pattern = ".nc"),
              list.files(file.path(dir_M, "git-annex/globalprep/_raw_data/AVISO_slr/d2017"),
                       full.names = TRUE, pattern = ".nc"),
              list.files(file.path(dir_M, "git-annex/globalprep/_raw_data/AVISO_slr/d2016/msla_monthly_mean"),
                      full.names = TRUE, pattern = ".nc"))

slr_nc_files <- slr_nc_files[-1:-2] # Double check this, but since the first two files are zip files I am confident in removing them. However, I did grab it directly from the most recent version of global so I so still want to make sure it's correct

```

A peek into what the monthly data looks like

```{r explore-monthly, eval=F}

plot(raster(slr_nc_files[1]), col = cols, axes = F, 
     main = paste("Year", substr(slr_nc_files[3], 90, 93), "Month", substr(slr_nc_files[3], 96, 97)))

```


## Convert .tif files into usable rasters

The following code is used to:

1. Rasterize each monthly NetCDF file
2. Rotate each raster so that the Atlantic Ocean is centered in the raster, and changes the extent from 0 to 360 to -180 to 180, which is needed when using wgs or us_albers projections/extents

```{r rasterize-monthly, results = 'hide'}

## Created 'msla_annual_mean', 'msla_annual_us_albers', 'msla_annual_us_albers_coastal', and 'msla_monthly' folders in 'int'

registerDoParallel(10)

## Parallel forloop function that rotates each monthly file, sets the long/lat projection, and keeps only coastal cells - saved to GitHub
foreach(file = slr_nc_files) %dopar% {
  file = slr_nc_files[1]
  
  m_yr <- substr(file, nchar(file)-10, nchar(file)-3) 
  
  ## Read in month raster
  r <- raster::raster(file) %>% 
    rotate()
  
  ## Crop raster to Palmyra 3nm extent
  r <- raster::crop(r, wgs_ext3) # Current projection is wgs84
  
  ## Write raster to int folder in prs_slr
  fp <- sprintf("%s/int/msla_monthly/msla_monthly_%s.tif", file.path(dir_anx, "dataprep/prs_slr"), m_yr)
  writeRaster(r, filename = fp, overwrite = TRUE)
}

# Plot the Jan 2018 raster to check 
plot(raster(file.path(dir_anx, "dataprep/prs_slr/int/msla_monthly/msla_monthly_2018_m01.tif")))
```


## Calculate annual mean sea level anomalies

Annual mean sea level anomaly rasters are calculated from the monthly data.

```{r calc-annual-mean, results='hide'}

msla_files <- list.files(sprintf("%s/int/msla_monthly", file.path(dir_anx, "dataprep/prs_slr")), 
                         full.names = TRUE)

maxyr <- substr(msla_files, 92, 95) %>% as.numeric() %>% max()

## Stack all rasters for this year, and calculate annual mean, then write as raster
registerDoParallel(6)
foreach(yr = c(1993:maxyr)) %dopar% {
  
  files <- msla_files[str_detect(msla_files, as.character(yr))]
  
  rast_annual_mean <- stack(files) %>%
    calc(mean, na.rm = TRUE) %>%
    writeRaster(filename = sprintf("%s/int/msla_annual_mean/msla_annual_%s.tif", file.path(dir_anx, "dataprep/prs_slr"), yr), 
                overwrite = TRUE)
}

# Plot the 2018 raster
plot(raster(file.path(dir_anx, "dataprep/prs_slr/int/msla_annual_mean/msla_annual_2018.tif"))) 
```


## Change the projection and mask

Since we are only interested in the increase in sea level near the coasts, we apply a mask to the raster layers that removes all cells farther than 3nm offshore. This mask was created previously for another part of this assessment. We also re-project to US Albers for consistency with the rest of the assessment.   

```{r projection-masking, results = 'hide'}

## 3nm offshore raster to select only nearshore cells
three_nm <- ocean_rast3_100
three_nm <- raster::crop(three_nm, usalb_ext3) # Crop to Palmyra extent
plot(three_nm)

## Re-project means to us albers
annual_means <- list.files(file.path(dir_anx, "dataprep/prs_slr/int/msla_annual_mean"), full = TRUE)

foreach(file = annual_means) %dopar% {  
  
  #file = annual_means[26]
  yr <- str_sub(file, -8, -5)
  
  rast_data <- raster(file)
  
  rast_data_reproj <- projectRaster(from=rast_data, to=three_nm, crs=us_alb, method = "ngb", over=FALSE) %>% 
    #projectRaster(crs = us_alb, over = FALSE, progress="text") %>% #problem in this line - goes from having values to values being NA
    raster::resample(three_nm, method = "ngb", 
             filename = sprintf("%s/dataprep/prs_slr/int/msla_annual_us_albers/mlsa_annual_us_albers_%s.tif", 
                                dir_anx, yr), overwrite = TRUE) %>% 
    mask(three_nm, filename = sprintf("%s/dataprep/prs_slr/int/msla_annual_us_albers_coastal/msla_annual_us_albers_coastal_%s.tif", dir_anx, yr), overwrite = TRUE)
}

# Plot 2018 raster to check:
plot(raster(file.path(dir_anx, "dataprep/prs_slr/int/msla_annual_us_albers_coastal/msla_annual_us_albers_coastal_2018.tif")))
```


## Reference Point

We are using a reference point 1.1 times larger than the maximum value in Palmyra from 1993-2018. The current maximum value is unlikely to be the future max, and setting this reference point allows for an increase in sea level rise pressure into the future.

```{r reference-point, eval=F}

coastal_rasts <- list.files(file.path(dir_anx, "dataprep/prs_slr/int/msla_annual_us_albers_coastal"), pattern = "tif", full.names = TRUE)

# Get data across all years
registerDoParallel(8)

vals <- foreach(i = 1993:2018, .combine = c) %dopar% { 
  #i = 2017
  
  coastal_rasts[which(str_sub(coastal_rasts, -8, -5) == i)] %>%
    raster() %>%
    getValues() %>%
    na.omit()
  
}

ref <- 1.1*max(vals)

```

The reference point is `r ref` meters.


## Rescale

We use the reference point to rescale all values from 0 to 1. If a value is greater than the reference point, it is automatically given a value of 1.

```{r rescale, results='hide'}

registerDoParallel(10) 

foreach(file = coastal_rasts) %dopar% { 
  #file = coastal_rasts[10]
  
  yr <- str_sub(file, -8,-5)
  
    raster::raster(file) %>%
    calc(fun = function(x){ifelse(x < 0, 0, x)}) %>% # Set all negative values to 0
    calc(fun = function(x){ifelse(x > ref, 1, x/ref)}, # Set equal to 1 if greater than ref, otherwise scale
         filename = sprintf("%s/dataprep/prs_slr/output/msla_rescaled/slr_%s.tif", dir_anx, yr), overwrite = TRUE)
    
}

```

***

# Results

```{r gif-results, eval=F}

coastal_rasts <- list.files(file.path(dir_anx, 'dataprep/prs_slr/output/msla_rescaled'), full.names = T) %>% 
                           stack()
                         
names(coastal_rasts) <- paste0("Year_", substr(names(coastal_rasts),5,8))

# Remove the 2019 layer (27th layer) - it isn't complete for all months
coastal_rasts <- dropLayer(coastal_rasts, 27)

# Make a gif animation
animation::saveGIF({
  for(i in 1:nlayers(coastal_rasts)){
     plot(coastal_rasts[[i]], col='cornsilk2', main=names(coastal_rasts[[i]]), axes=F, legend=F)
      # don't forget to fix the zlimits
    plot(coastal_rasts[[i]], zlim=c(0,1), axes=F, col=cols, add=T)
      
  }
}, movie.name = 'slr_annual_rescaled.gif')

```

<img src="slr_annual_rescaled.gif"/>


## Extract Scores

Extract data per year for the entire Palmyra region.  

```{r extract-scores, eval=F}

## Read in raster files
pressure_stack <- lapply(list.files(file.path(dir_anx, 'dataprep/prs_slr/output/msla_rescaled'), full.names=T), raster) %>%
  brick()

# Extract data for Palmyra:
pal_regionstats <- cellStats(pressure_stack, mean)%>% 
  as.data.frame() %>% 
  rename(pressure_score = ".") %>% 
  tibble::rownames_to_column("file_name") %>% 
  mutate(year = substr(file_name, 5, 8)) %>% 
  select(-file_name) %>% 
  mutate(region_id = 1, 
         year = as.numeric(year))

# Data for 2019 and 2020 are estimated from 2018 since the 2019 data is incomplete
score_2018 <- pal_regionstats$pressure_score[pal_regionstats$year == 2018]

add_19_20 <- data.frame(
  region_id = rep(1, 2),
  year = c(2019, 2020),
  pressure_score = rep(score_2018, 2)
)

# Finalized data frame for pressure score:
slr_data <- pal_regionstats %>% 
  filter(year >= 2005 & year < 2019) %>% 
  rbind(add_19_20) %>% 
  dplyr::select(region_id, year, pressure_score)

# Save to output folder
write.csv(slr_data, file.path(dir_prs, "output/slr_pressure.csv"))
```

## 2018 scores

Check the scores for 2018, the last full year of available data

```{r map-scores, eval=F}
# Source the plot scores function 
source(here('src/R/plot_scores.R'))

# Use slr output data
slr_data <- read_csv(file.path(dir_prs, "output/slr_pressure.csv"))

last_year <- slr_data %>%
  filter(year==2018)

## map_scores is a function to plot a tmap map of the scores
map_scores(score_obj = last_year, score_var = last_year$pressure_score, scale_label = "Pressure Score", map_title = "Sea Level Rise")
```


## Visualize through time

```{r graph-scores-overtime}

slr_overtime <-ggplot(slr_data)+
  geom_line(aes(x=year, y = pressure_score), color="dodgerblue4")+
  ggtitle("Sea Level Rise Pressure Score") +
  ylab("Score") +
  xlab("Year") +
  theme_classic() 
slr_overtime


ggsave(file.path(dir_prs, "figs/scores_2005-2020.png"), width=7, height=5, dpi=300)

```


## Save To Toolbox

```{r save-to-toolbox, eval=F}
write.csv(slr_data, file.path(dir_scores, "layers/cc_slr.csv", row.names=FALSE)
```
