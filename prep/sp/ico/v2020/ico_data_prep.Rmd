---
title: 'OHI+ Palmyra 2020 - Iconic species subgoal'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
     #in_header: '../../../workflow/templates/ohi_hdr.html' - need to update this
  pdf_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

# Summary:  Iconic Species Subgoal (Sense of Place)

This script prepares scores (status and trend) for Iconic Species in Palmyra. For each iconic species, extinction risk category is pulled based on current and past assessments; by tracking the assessed extinction risk over time, we can understand the trends of extinction risk for iconic species directly rather than using the "population trend" method from prior OHI assessments.

The Iconic Species sub-goal model calculates status based upon an unweighted average of species health for all 'iconic' species found within the reporting region.

From Halpern et al (2012):

> Iconic species are those that are relevant to local cultural identity through a speciesâ€™ relationship to one or more of the following: 1) traditional activities such as fishing, hunting or commerce; 2) local ethnic or religious practices; 3) existence value; and 4) locally-recognized aesthetic value (e.g., touristic attractions/common subjects for art such as whales). Habitat-forming species are not included in this definition of iconic species, nor are species that are harvested solely for economic or utilitarian purposes (even though they may be iconic to a sector or individual). ...
> Ultimately, almost any species can be iconic to someone, and so the intent with this goal was to focus on those species widely seen as iconic within a country, and iconic from a cultural or existence value (rather than for a livelihoods or extractive reason). ...
> The reference point is to have the risk status of all assessed species as Least Concern (i.e., a goal score = 1.0)
The Status of this sub-goal (X~ICO~) is then the % of iconic species in each threat category (as defined by the IUCN Red List), such that:

$$X_{ICO} = \frac{\displaystyle\sum_{category}S_{cat}*w_{cat}}{\displaystyle\sum_{category}S_{cat}}$$
where for each IUCN threat category:
* *S~cat~* is the number of assessed species in the category
* *w~cat~* is the status weight assigned for that category (note, these are the inverse of the risk value used in the SPP calculations):
    * 'LC' = 1.0, 'NT' = 0.8, 'VU' = 0.6, 'EN' = 0.4, 'CR' = 0.2, 'EX' = 0.0

ICO trend is calculated in a similar manner, but weightings are assigned according to IUCN population trend: 'Decreasing' = -0.5, 'Stable' = 0.0, 'Increasing' = +0.5.  


# Data Sources

**List of iconic species:**

* __Reference__: 
    * U.S. Fish and Wildlife Service. (2016, January 14). Wildlife and Habitat. Retrieved from <https://www.fws.gov/refuge/Palmyra_Atoll/wildlife_and_habitat/index.html> 
        * __Accessed__: 04 June 2020   

**Species native country information:**

* __Reference__: 
    * IUCN 2020. IUCN Red List of Threatened Species. Version 2020-1 <www.iucnredlist.org>
        * __Accessed__: 9 June 2020 
* __Native data resolution__: Country level (by country name)
* __Time range__: 1965-2020 (discrete past assessments by species) 
* __Format__:  JSON


# Methods

## Setup 

```{r setup, echo = FALSE, message = FALSE, warning = FALSE, eval=FALSE}

knitr::opts_chunk$set(echo = FALSE)
library(rredlist)
library(tidyverse)
library(dplyr)
library(raster)
library(here)

# Set filepaths and source functions
source(here('src/R/common.R'))

goal       <- 'globalprep/ico'
scenario   <- 'v2020'
dir_server <- file.path(dir_M, 'git-annex', goal)
dir_goal   <- '~/github/pal-prep/prep/sp/ico/v2020'

source(file.path(dir_goal, 'ico_fxn.R'))

# Set api for access to IUCN:
api_file <- file.path(dir_M, 'git-annex/globalprep/spp', 'api_key_gc.csv')
api_key <- scan(api_file, what = 'character')
```

## Download Species List from IUCN 

Using the IUCN API, we accessed the full IUCN species list for the US Minor Outlying Islands at <http://apiv3.iucnredlist.org/api/v3/country/getspecies/id/%s?token=%s>. With some minor formatting, this list contains the following variables:

iucn_sid | scientific_name | subspecies | rank | subpopulation | category | country_code

```{r get-spp-iucn, eval=F}

## get a dataframe of all iucn redlist species
out <- rl_sp(all = TRUE, key = api_key)
all_df <- do.call(rbind, lapply(out, "[[", "result"))
all_df_comp <- all_df %>%
  dplyr::select(-infra_rank, -infra_name) %>%
    dplyr::rename(iucn_sid = taxonid, sciname = scientific_name) %>%
    setNames(names(.) %>%
               stringr::str_replace('_name', ''))


spp_country_url <- 'http://apiv3.iucnredlist.org/api/v3/country/getspecies/id/%s?token=%s'

countries <- rl_countries(key = api_key)

#UM is United States Minor Outlying Islands country code
# UM species risks (1532 species)
spp_um <- rl_sp_country('UM', key = api_key)$result %>%
  mutate(country_code = "UM") %>%
  rename("iucn_sid" = "taxonid")

# join with all_df_comp to get the kingdom,phylum,order, etc
spp_pal <- all_df_comp %>%
  inner_join(spp_um, by = c("iucn_sid", "category")) %>%
  dplyr::select(-scientific_name)

# Write UM species list as csv:
write_csv(spp_pal, file.path(dir_goal, 'raw/spp_list_from_api.csv'))
```

## Get Iconic Species List

This initial list of iconic species is compiled based on USFWS birds, mammals, reptiles, and invertebrates list found [here](https://www.fws.gov/refuge/Palmyra_Atoll/wildlife_and_habitat/index.html). 

Birds: brown booby (Sula leucogaster), masked booby (Sula dactylatra), red-footed booby (Sula sula), black noddy (Anous minutus),
brown noddy (Anous stolidus), great frigatebird (Fregata minor),sooty tern (Onychoprion fuscata),
bristle-thighed curlew (Numenius tahitiensis), pacific golden plover (Pluvialis fulva), wandering tattler (Heteroscelus incanus),
ruddy turnstone (Arenaria interpres)   

Mammals: pacific bottlenose dolphins (Tursiops aduncus), spinner dolphins (Stenella longirostris),
melon-headed whales (Peponocephala electra)   

Reptiles: green turtles (Chelonia mydas), hawksbill turtles (Eretmochelys imbricata)    

Invertebrates: stony corals (many species), giant clams (Tridacna gigas), coconut crabs (Birgus latro)   

```{r usfws-ico-spp, eval=F}
# Create vector of iconic species scientific names from the USFWS webpage to cross reference (17 spp total)
# Note this list excludes specific coral and fish species that weren't listed on the USFWS webpage
sci_name <- c("Sula leucogaster", "Sula dactylatra", "Sula sula", "Anous minutus", "Anous stolidus",
          "Fregata minor", "Onychoprion fuscata", "Numenius tahitiensis", "Pluvialis fulva",
          "Heteroscelus incanus", "Arenaria interpres", "Tursiops aduncus", "Stenella longirostris",
          "Peponocephala electra", "Chelonia mydas", "Eretmochelys imbricata", "Tridacna gigas",
          "Birgus latro")
# Vector of common names (in same order as sci_name)
common_name <- c("Brown booby", "Masked booby", "Red-footed booby", "Black noddy", "Brown noddy", 
                 "Great frigatebird", "Sooty tern", "Bristle-thighed curlew", "Pacific golden plover",
                 "Wandering tattler", "Ruddy ternstone", "Pacific bottlenose dolphin", "Spinner dolphin",
                 "Melon-headed whales", "Green turtle", "Hawksbill turtle", "Giant clam", "Coconut crab")

# Create the USFWS ico species list, include same columns as global so they can be combined - comname, sciname, ico_gl, and ico_rgn_id
ico_list_usfws <- data.frame(comname = common_name, sciname = sci_name,
                             ico_gl = rep("FALSE", length(sci_name)), ico_rgn_id = rep(150, length(sci_name)))


# Write csv file
write_csv(ico_list_usfws, file.path(dir_goal, 'raw/ico_list_usfws.csv'))
```

USFWS list is small, add the iconic species for US Minor Outlying Islands from the master iconic spp list used in the global assessment.  

The OHI global list of Iconic Species is based upon the original ICO list generated in 2011, using species identified as globally iconic (WWF Flagship species and Priority species) or regionally iconic (based upon WWF regional/local priority species and nation-specific lists).

```{r get-global-ico-spp, eval=F}
# ico master species list from Mazu: 'git-annex/globalprep/ico/ico/ico_global_list2016.csv'
# function called get_ico_list() defined in the ico_fxn.R file
ico_list_global <- get_ico_list(reload = TRUE) 

write_csv(ico_list_global, file.path(dir_goal, 'raw/ico_list_global.csv'))
```

Filter the full global iconic species list for species that are globally iconic or species iconic to Palmyra Atoll (region id 150) and add the USFWS list to make a single iconic spp list  

```{r pal-ico-spp, eval=F}
ico_list_global <- read_csv(file.path(dir_goal, "raw/ico_list_global.csv"))
ico_list_usfws  <- read_csv(file.path(dir_goal, "raw/ico_list_usfws.csv"))

# Filter global species list for only those globally iconic or iconic to palmyra 
global_ico <- ico_list_global %>% 
  filter(ico_gl == "TRUE" | ico_rgn_id == 150) # 39 total species from global list but none from rgn 150

# See if there is any overlap in the USFWS ico list and the global ico list
setdiff(ico_list_usfws$sciname, global_ico$sciname)

# Only two sea turtles are included in the global list - exclude these when combining the datasets 
ico_spp_pal <- ico_list_usfws %>% 
  filter(sciname != "Chelonia mydas" & sciname != "Eretmochelys imbricata") %>% 
  rbind(global_ico) # 55 species 

write_csv(ico_spp_pal, file.path(dir_goal, 'raw/ico_list_pal.csv'))
```


## Identify extant ICO species populations

Filtering the complete IUCN species list for US Minor Outlying islands to include only the identified Iconic Species from either the USFWS website or the 2011 ico list.  

``` {r combine-iucn-spp-info-with-ico-list, eval= F}

spp_pal      <- read_csv(file.path(dir_goal, 'raw/spp_list_from_api.csv'))
ico_list_pal <- read_csv(file.path(dir_goal, 'raw/ico_list_pal.csv')) 


# Get the status information for the 55 species 
ico_list <- ico_list_pal %>%
  left_join(spp_pal %>% 
            dplyr::select(iucn_sid, sciname, category),
            by = 'sciname') %>% 
  mutate(all_na = ifelse(category == is.na(category) & iucn_sid == is.na(iucn_sid) & ico_rgn_id == is.na(ico_rgn_id), "yes", "no")) %>% 
  filter(all_na == "no") %>% # keep columns only for species found in palmyra 
  dplyr::select(-all_na)

## A few NAs from USFWS list:
# Figure out which ones didn't match
no_status <- ico_list %>% 
  filter(is.na(category) & ico_rgn_id == 150)

# Make vector of those that didn't match
ico_not_listed <- no_status$sciname

# Filter overall species list for those that didnt match
pal_ico_not_listed <- all_df_comp %>%
  filter(sciname %in% ico_not_listed) # found 4 of the 6 species

# Join this to the no status to fill in the missing data
no_status_fill <- no_status %>% 
  left_join(pal_ico_not_listed %>% 
              dplyr::select(iucn_sid, sciname, category),
            by = 'sciname') %>% # only two not matched 
  dplyr::select(-iucn_sid.x, -category.x) %>% 
  rename("iucn_sid" = "iucn_sid.y",
         "category" = "category.y")

# Still missing terns and tattlers 
# Found them on the IUCN webpage and pulled the iucn_sid for the web address and status from the spp page
missing_sid <- data.frame(sciname = c("Onychoprion fuscata", "Heteroscelus incanus"),
                          missing_id = c(22694740, 22693305),
                          missing_cat = c("LC", "LC"))

# missing category needs to be a character not a factor
missing_sid$missing_cat <- as.character(missing_sid$missing_cat)

# Join the two missing species to the no status fill to complete the missing species list
no_status_filled <- no_status_fill %>% 
  left_join(missing_sid, by = "sciname") %>% 
  mutate(iucn_sid = ifelse(is.na(iucn_sid), missing_id, iucn_sid)) %>% 
  mutate(category = ifelse(is.na(category), missing_cat, category)) %>% 
  dplyr::select(-missing_id, - missing_cat)

# Join the filled in USFWS data back to the ico_list
ico_list_prepped <- ico_list %>% 
  rbind(no_status_filled) %>% 
  filter(!is.na(category))

write_csv(ico_list_prepped, file.path(dir_goal, 'int/ico_list_prepped.csv')) #23 species in 2020
```

## Historic threat

We accessed the IUCN API to determine past IUCN assessments for each of the identified iconic species: http://apiv3.iucnredlist.org/api/v3/species/history/id/?token=.

Each assessment includes a year and an extinction risk, along with additional information on the assessment.

```{r get-past-assessments, eval=F}

pal_ico_list <- read_csv(file.path(dir_goal, 'int/ico_list_prepped.csv'))
ico_ids      <- unique(pal_ico_list$iucn_sid)

# use rl_history, create loop that runs it for each id in our iconic species list
for(i in seq_along(ico_ids)){
id = ico_ids[i]
out <- rl_history(id = id, key = api_key) # this comes out as a list
df <- as.data.frame(out)
 if(i == 1) {
   raw_ico_assess <- df
 } else {
   raw_ico_assess <- rbind(raw_ico_assess, df)
 }
}

# Save historic assessments to the int folder
write_csv(raw_ico_assess, file.path(dir_goal,'int/raw_ico_assess.csv'))
```

# Clean Up Assessment Data

Want to break apart any dual categories and make sure all categories have a 1 or 2 digit upper case code 
```{r clean-raw-assessment-data, eval=F}
raw_assess <- read_csv(file.path(dir_goal, 'int/raw_ico_assess.csv'))

raw_assess_tidy <- raw_assess %>% 
  rename("iucn_sid" = "name",
         "year" = "result.year",
         "cat" = "result.code",
         "cat_txt" = "result.category") %>% 
   mutate(cat = toupper(cat),
         cat = str_replace(cat, 'LR/', ''),
         cat = ifelse(cat %in% c('K', 'I'), 'DD', cat),
         cat = ifelse(cat == 'NR', 'NE', cat),
         cat = ifelse(str_detect(toupper(cat_txt), 'VERY RARE'), 'CR', cat),
         cat = ifelse(str_detect(toupper(cat_txt), 'LESS RARE'), 'T', cat),
         cat = ifelse(str_detect(toupper(cat_txt), 'STATUS INADEQUATELY KNOWN'), 'DD', cat),
         cat = ifelse(cat == 'V', 'VU', cat), 
         cat = ifelse(cat == 'E', 'EN', cat))

# Create category weights that will be used to calculate scores
pop_cat <- data.frame(cat       = c("LC", "NT", "VU", "EN", "CR", "EX", "T", "CD", "NE", "DD"), 
                      cat_score = c(   0,  0.2,  0.4,  0.6,  0.8,  1.0, 0.6,  0.3,   NA,  NA),
                      stringsAsFactors = FALSE)

# Join the scores to the tidy raw data
ico_assess <- raw_assess_tidy %>% 
  left_join(pop_cat, by = "cat") %>% 
  filter(!is.na(cat_score)) %>%
  distinct() %>%
  arrange(iucn_sid, year)

# Save cleaned assessment data to the int folder
write_csv(ico_assess, file.path(dir_goal,'int/ico_assess.csv'))
```


# Gapfill Timeseries

Using `tidyr::complete()` and `tidyr::fill()`, we create a full time series for all species from 2014 to 2020. 

```{r fill-timeseries, eval=F}

ico_assess <- read_csv(file.path(dir_goal, 'int/ico_assess.csv'))

# Fill in category score for missing years based on previous year's data:
ico_assess_full <- ico_assess %>%
  mutate(eval_yr = year) %>% 
  arrange(iucn_sid, year) %>%
  complete(year = full_seq(year, 1), nesting(iucn_sid)) %>%
  group_by(iucn_sid) %>%
  fill(cat, cat_txt, cat_score, eval_yr) %>% ## fills all the way to latest year
  ungroup() %>% 
  filter(year >= 2000) # keep 20 years of data

# Need to add 2020 data  
assess_2019 <- ico_assess_full %>% 
  filter(year == 2019)

# 2020 data is based on the 2019 data
add_2020 <- data.frame(year = rep(2020, length(assess_2019$iucn_sid)),
                     iucn_sid = assess_2019$iucn_sid,
                     cat = assess_2019$cat,
                     cat_txt = assess_2019$cat_txt,
                     cat_score = assess_2019$cat_score,
                     eval_yr = assess_2019$eval_yr)

ico_assess_2020 <- ico_assess_full %>% 
  rbind(add_2020)

# Save file to int folder
write_csv(ico_assess_2020, file.path(dir_goal,'int/ico_assess_full.csv'))
```


# Prep layer for toolbox

The toolbox wants `rgn_id`, species `sciname`, and extinction risk `category` for the basic calculations.  Since some regions contain multiple subpops (or parent/subpop) we also include `iucn_sid` to differentiate. This information is included for each `year`, filtered back to the year 2014.  

```{r final-ico-layer-prep}

ico_assessments <- read_csv(file.path(dir_goal,'int/ico_assess_full.csv'))
pal_ico_list    <- read_csv(file.path(dir_goal, 'int/ico_list_prepped.csv')) 

# Add rgn_id to the ico dataframe 
ico_rgn <- ico_assessments %>% 
  mutate(rgn_id = 1)

# Get scientific names 
pal_scinames <- pal_ico_list %>% 
  dplyr::select(sciname, iucn_sid)

# Add scientific names
ico_scinames <- ico_rgn %>% 
  group_by(iucn_sid) %>% 
  left_join(pal_scinames, by = "iucn_sid") %>% 
  dplyr::select(rgn_id, iucn_sid, sciname, year, category = cat, cat_score)

# Save to the output folder - this will be used to calculate the scores
write_csv(ico_scinames, file.path(dir_goal,'output/ico_spp_scores.csv'))
```

# Calculate Status

We will use the category scores for each species to calculate the status. The status for Palmyra is just the average of the status of each iconic species found in the region. 

```{r calc-status, eval=F}
ico_spp_scores <- read_csv(file.path(dir_goal,'output/ico_spp_scores.csv'))

# Find the status score for each year 
ico_status <- ico_spp_scores %>%
  rename(region_id = rgn_id) %>% 
  group_by(year, region_id) %>%
  summarize(mean_cat = round(mean(cat_score, na.rm = TRUE), 5), 
            status = (1 - mean_cat)) %>% 
  ungroup() %>% 
  dplyr::select(-mean_cat)
```

# Save to Toolbox
```{r save-status-to-toolbox, eval=F}
dir_scores <- '~/github/pal-scores/region'

write_csv(ico_status, file.path(dir_scores, 'layers/ico_status.csv'))
```






