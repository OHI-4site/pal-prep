---
title: 'OHI+ Palmyra 2020: Habitats Subgoal Corals'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
     #in_header: '../../../workflow/templates/ohi_hdr.html' - need to update this
  pdf_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

# Summary
This script uses benthic habitat mapping shapefiles to calculate the percent live coral cover across three regions of interest on the reef to estimate the condition of coral reef habitats. 

# Setup

```{r setup, message = F, warning = F}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(janitor)
library(sf)
library(raster)
library(here)

# Source and set file paths
source(here('src/R/common.R'))

dir_goal   <- '~/github/pal-prep/prep/bd/hab/v2020'
dir_anx    <- file.path(dir_M, 'git-annex/foursite/palmyra')
```

# Methods

## Get Coral Cover Maps

Coral cover maps were downloaded from the National Centers for Coastal Ocean Science (NCCOS) benthic habitat mapping project for Palmyra Atoll, found [here](https://products.coastalscience.noaa.gov/collections/benthic/e58palmyra/#horizontalTab3)   

Data was downloaded on June 30, 2020, and habitat maps were completed in December 2011.   

Cover categories are adapted to a numeric scale as follows:  

 - 0   - <10% = 1   
 - 10% - <50% = 2   
 - 50% - <90% = 3   
 - 90% - 100% = 4   

The following zones are grouped together to form the three major reef zone of interest:  

 - Back Reef: Not grouped with any other zone   
 - Fore Reef: Fore reef and the Bank/Shelf   
 - Lagoon: Lagoon and Channel   

Using these groupings, the total number of observations in each zone are:   

 - Back Reef: 126   
 - Fore Reef: 156  
 - Lagoon: 146   
 
```{r coral-maps, eval=F}

hab_map <- st_read(file.path(dir_anx, '_raw_data/NCCOS_data/habitat_map'), layer = "Palmyra_Habitat_Map_Final") %>% 
  st_transform(wgs84)

# Interested in the coral cover map which is column 'P_CORAL_CV'
coral_map <- hab_map %>% 
  clean_names() %>% # lower case column names
  dplyr::select(zone, p_coral_cv)

plot(coral_map)

# Extract the percent coral cover for backreef, forereef (and bank/shelf), and lagoon (and channel)
zones <- coral_map %>% 
  filter(zone == "Back Reef" | zone == "Fore Reef" | zone == "Lagoon" |
         zone == "Bank/Shelf" | zone == "Channel") %>% 
  filter(p_coral_cv != "N/A") %>% 
  mutate(zone = as.character(zone),
         p_coral_cv = as.character(p_coral_cv),
         zone = ifelse(zone == "Bank/Shelf", "Fore Reef", zone),
         zone = ifelse(zone == "Channel", "Lagoon", zone)) %>% 
  mutate(cover_cat = case_when(p_coral_cv == "90% - 100%" ~ 4,
                               p_coral_cv == "50% - <90%" ~ 3,
                               p_coral_cv == "10% - <50%" ~ 2,
                               p_coral_cv == "0% - <10%"  ~ 1))

# Save layer to int folder as shp
st_write(zones, file.path(dir_goal, "int/coral_zones.shp"), driver = 'ESRI Shapefile')

# Also save layer as csv
write_csv(zones, file.path(dir_goal, "int/coral_zones.csv"))
```

## Calculate Coral Status

Calculate the average cover category by zone. Reference points for coral cover zones are:   

 - Fore Reef: 50-90% (3)   
 - Back Reef: 10-50% (2)   
 - Lagoon:    10-50% (2)   
 
Coral reef status is calculated as number of data points falling within or above the reference point category compared to the overall number of data points in each zone of the reef.   

$status~=~ref_{n}~/~total_{n}$   

Where $ref_{n}$ is the number of data points in each zone falling within or above the reference point category and $total_{n}$ is the total number of data points in each zone.   

```{r calculate-status, eval=F}

zones <- read_csv(file.path(dir_goal, "int/coral_zones.csv"))

# Define reference point categories
ref_fore <- 3
ref_back <- 2
ref_lag  <- 2

# Find the number of data points for each cover category and add reference categories
zone_n <- zones %>%
  group_by(zone, cover_cat) %>%
  summarise(n_cover = n()) %>% 
  mutate(ref = case_when(zone == "Fore Reef" ~ ref_fore,
                         zone == "Back Reef" ~ ref_back,
                         zone == "Lagoon" ~ ref_lag))

# Find the status scores using the number of points that are at the reference category or better
coral_status <- zone_n %>% 
  filter(cover_cat == ref | cover_cat > ref) %>% 
  group_by(zone) %>% 
  summarize(n_ref = sum(n_cover)) %>% 
  mutate(n_total = case_when(zone == "Back Reef" ~ 126,
                             zone == "Fore Reef" ~ 156,
                             zone == "Lagoon" ~ 146),
         status = n_ref / n_total)
```

## Save to Toolbox 
