---
title: 'OHI+ Palmyra 2020: 3_spp_status'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
     #in_header: '../../../workflow/templates/ohi_hdr.html' - need to update this
  pdf_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

# Summary

This is the third script in the species data prep. It takes the fully combined IUCN and Palmyra species lists and calculates the status score.   

# Setup 

```{r setup, message = F, warning = F}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(here)

# Source and set file paths
source(here('src/R/common.R'))

dir_goal   <- '~/github/pal-prep/prep/bd/spp/v2020'

```

# Methods

## Calculate Species Scores

Add category weights to species list and calculate species status

```{r calc-spp-status, eval=F}
# Use the combined all species lists
all_spp <- read_csv(file.path(dir_goal, 'int/all_spp_list.csv')) 


# Create category weights that will be used to calculate scores
pop_cat <- data.frame(category  = c("LC", "NT", "VU", "EN", "CR", "EX", "T", "CD", "NE", "DD"), 
                      cat_score = c(   0,  0.2,  0.4,  0.6,  0.8,  1.0, 0.6,  0.3,   NA,  NA),
                      stringsAsFactors = FALSE)

# Join category weights to species list
spp_status <- all_spp %>% 
  left_join(pop_cat, by = "category") %>% 
  filter(!is.na(cat_score)) %>%
  distinct() %>% 
  mutate(region_id = 1,
         status = cat_score,
         year = 2020) %>% # need a year for toolbox to run
  dplyr::select(region_id, sciname, class, common, status, year) 

```

## Test Alternate Status 

Testing a second method for calculating status. The reference point here is 100% of historically occurring species are present in healthy abundance. Healthy is defined as being a category of "Least Concern" in the IUCN Red List.   

The status is first calculated for each class as the proportion of species in the class with a rank of "Least Concern". The overall status is then the average of the status score for each class, as given by the following equations:   

$class_{status}~=~n_{LC}~/~n_{class}$   

Where $n_{LC}$ is the number of species in each class that have a rank of "Least Concern" and $n_{class}$ is the total number of species in each class. 

$spp_{status}~=~mean(class_{status})$   


```{r calc-species-status2, eval=F}
# Use the combined all species lists
all_spp <- read_csv(file.path(dir_goal, 'int/all_spp_list.csv')) 

# Find the number of species in each class 
class_counts <- all_spp %>% 
  group_by(class) %>% 
  tally() %>% 
  rename(total = n)

# Find the number of species ranked LC in each class 
class_status <- all_spp %>%
  group_by(class, category) %>% 
  tally() %>% 
  rename(number_spp = n) %>% 
  left_join(class_counts, by = "class") %>% 
  filter(category == "LC") %>% 
  mutate(status = number_spp / total)

# Check score to compare:
spp_score <- mean(class_status$status) * 100
  
```

## Save to Toolbox 

Write out csv to the toolbox

```{r save-to-toolbox, eval = F}
# save to toolbox
dir_scores <- '~/github/pal-scores/region'

write_csv(spp_status, file.path(dir_scores, 'layers/spp_status.csv'))
```
