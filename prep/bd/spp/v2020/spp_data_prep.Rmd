---
title: 'OHI+ Palmyra 2020: Species subgoal'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
     #in_header: '../../../workflow/templates/ohi_hdr.html' - need to update this
  pdf_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

# Summary

This script takes the OHI Palmyra region shapefile and compares it to the global shapefiles we have from IUCN to extract all species maps that fall within our region. We then get the conservation status for all the species falling within the Palmyra 50nm boundary and calculate the species scores. A lot of this code dips into the `spp_risk_dists` repo from Casey O'Hara: 
https://github.com/saraorofino/spp_risk_dists  

# Setup

```{r setup, message = F, warning = F}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(sf)
library(raster)
library(rfishbase)
library(rredlist)
library(taxize)
library(rentrez) # to use the api key for searching the NCBI database
library(here)

# Source and set file paths
source(here('src/R/common.R'))

dir_goal   <- '~/github/pal-prep/prep/bd/spp/v2020'

# palmyra region shapefile 50nm boundary
pal_shp <- pal_monument

# api keys for IUCN 
api_file <- file.path(dir_M, 'git-annex/globalprep/spp', 
                      'api_key_gc.csv')
api_key <- scan(api_file, what = 'character')
```

# Methods

## Get Cell IDs and Species List
First step is to get a list of the cell IDs contained in the pal_region

```{r global-cells, eval=F}
# these are global cell ids in raster format pulled from the spp_risk_dists repo.
cells <- raster("~/github/spp_risk_dists/_spatial/cell_id_rast.tif")
```

Then I select only those cells in Palmyra and use that list to query the larger species data. First we transform our regions shapefile into the same CRS as the cell ID raster (`cells`).

```{r reproject-rgns, eval=F}
# reproject to our CRS
pal_reproj <- st_transform(pal_shp, crs = "+proj=cea +lon_0=0 +lat_ts=45 +x_0=0 +y_0=0 +ellps=WGS84
+units=m +no_defs")
plot(cells)
plot(pal_reproj, add = T)
```

Extract the cell ids for our region
```{r extract-pal-cell-ids, eval=F}
pal_cells <- raster::extract(cells, pal_reproj) %>%
  unlist()
```

Read in files that contain all the species ranges and information

```{r spp-files, eval=F}
# .csv file that lists all species and the file path to their map
spp_maps <- read_csv('~/github/spp_risk_dists/_data/spp_marine_maps_2019-2.csv',
                     col_types = 'ddciccc')

# file with species information to link to iucn_sid at the end
spp_info <- read_csv("/home/ohara/git-annex/spp_risk_dists/iucn/spp_info_from_api_2019-2.csv")
```

The following forloop goes through each species:  
- finds it's species path
- reads in the species .csv that lists all global cells where it is found
- filters that list to just those in Palmyra
- returns an aggregated dataframe (`taxa_cells_df`) with all species scientific names, their unique ids (sids), and cellIDs

```{r get-spp-files, eval = F}
# grab each taxa's folder filepath
taxa <- spp_maps$dbf_file %>%
    unique() %>%
    str_replace('\\....$', '')

# create an empty list that is the length of all taxa. We are going to fill this list  
taxa_cells_list <- vector('list', length = length(taxa))


# for each taxa, grab the species map (raster) and filter to only keep those cells in Palmyra.
for(i in seq_along(taxa)) { ### i <- 5
    taxon <- taxa[i]
    print(i)
    spp_ids_in_taxon <- spp_maps %>%
     filter(str_detect(dbf_file, taxon)) %>%
      .$iucn_sid
    cat(sprintf('processing %s spp in %s...\n', length(spp_ids_in_taxon), taxon)) 
    
    spp_cells <- parallel::mclapply(spp_ids_in_taxon, mc.cores = 32,
                                    FUN = function(x) { ###x <- spp_ids_in_taxon[1]
                                      f <- file.path('/home/ohara/git-annex/spp_risk_dists/spp_rasters_2019',
                                                     sprintf('iucn_sid_%s.csv', x))
                                      if(file.exists(f)) {
                                        y <- read_csv(f, col_types = 'di') %>%
                                          mutate(iucn_sid = x) %>%
                                          dplyr::select(-presence)  %>%
                                          filter(cell_id %in% pal_cells)
                                      } else {
                                        y <- data.frame(cell_id = NA,
                                                        iucn_sid = x, 
                                                        f = f, error = 'file not found')
                                      }
                                      return(y)
                                    }) %>%
      bind_rows() %>%
      mutate(spp_gp = taxon)
    
    taxa_cells_list[[i]] <- spp_cells
}
  
taxa_cells_df <- taxa_cells_list %>%
    bind_rows()  %>%
    filter(!is.na(cell_id)) %>%
    dplyr::select(iucn_sid) %>%
    distinct() %>%
    left_join(spp_info)

# save raw output to the raw folder
write.csv(taxa_cells_df, file.path(dir_goal, 'raw/spp_list_raw.csv'))
```

## Add Common Names
Attach common names using `rredlist`

```{r get-common-name, eval=F}

# read in raw data list:
spp_list_raw <- read_csv(file.path(dir_goal, 'raw/spp_list_raw.csv')) %>% 
  dplyr::select(-X1)

# create list of scientific names of species
scinames <- spp_list_raw$sciname

# create loop around redlist function rl_search to find common names  
# create empty data frame that will be filled
iucn_common_names <- data.frame() 


for(i in 1:length(scinames)){
  sp <- scinames[i]
  print(i)

  comm <- rredlist::rl_search(sp, key = api_key)$result$main_common_name
  
  df <- data.frame(sciname = sp,
                   common = comm)
  
  iucn_common_names <- rbind(iucn_common_names, df) %>%
    mutate(common = as.character(common),
         sciname = as.character(sciname))
}
```

Check out the ones we are still missing for common name   

```{r missing-spp, eval=F}

miss_sp <- iucn_common_names %>%
  filter(is.na(common))
```

We are still missing `r nrow(filter(iucn_common_names, is.na(common)))`. Check fishbase

```{r fishbase, eval = F}

# select scientific names of missing species
sp <- iucn_common_names %>%
  filter(is.na(common))  %>%
  dplyr::select(sciname)

# check fishbase for common names
fb_list <- species(sp$sciname) %>%
  dplyr::select(Species, FBname)

# filter out NAs
fb <- fb_list %>% 
  filter(!is.na(FBname)) 

```

This got us `r nrow(filter(fb_list, !is.na(FBname)))` more common names we need to add back in.

```{r add-fishbase, eval=F}
# add back in common names
out <- iucn_common_names %>%
  left_join(fb_list, by = c("sciname" = "Species")) %>%
  mutate(common_fb = ifelse(is.na(common), FBname, common)) %>%
  dplyr::select(-FBname, -common)
```

Use the `taxize` R package to try and get more of the missing common names

```{r taxize, eval = F}
# missing scientific names
missing_scinames <- out %>%
  filter(is.na(common_fb)) %>%
  .$sciname

# pull out common names from taxize
common_names <- c()
for(i in 1:length(missing_scinames)){ #i <- 1
  sp <- missing_scinames[i]
  comm <- taxize::sci2comm(sp, db = "itis")
  print(comm)
  
common_names <- c(common_names, comm)
}


# turn list into dataframe
df <- do.call(rbind,lapply(common_names,data.frame))
df$sciname <- rownames(df)
df2 <- df %>%
  rename(common = X..i..) %>%
  filter(!is.na(common)) %>%
  mutate(sciname = str_extract(sciname, "[^.]+")) # remove numbers

## Try using the NCBI in taxize
uids <- get_uid(missing_scinames)

# combine uids with sciname 
uids_found <- data.frame(sciname = missing_scinames, uid = uids)
uids_found$sciname <- as.character(uids_found$sciname)

# Get an api key using use_entrez with the account I created through NCBI 
# Set api key in the environment using rentrez::set_entrez_key()
taxize::use_entrez()
rentrez::set_entrez_key("c6d9419d922a77ebe9e15f9a4c0e46a12108")

# Search for common names using the NCBI database
common_names <- sci2comm(uids_found$sciname, db = 'ncbi') # only found four more 
common_found <- common_names %>% 
  unlist() %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sciname") %>% 
  rename("ncbi_common" = ".")

# make sure names are characters not factors 
common_found$ncbi_common <- as.character(common_found$ncbi_common)

```

None of the 104 remaining species had common names in the taxize 'itis' database but I found four more in the 'ncbi' database

Add common names and select final list of spp information

```{r add-common-names, eval=F}
# add back in common names from fishbase and ncbi 
add_common <- iucn_common_names %>%
  left_join(common_found, by = "sciname") %>%
  mutate(common = ifelse(is.na(common), ncbi_common, common)) %>% 
  dplyr::select(-ncbi_common) %>% 
  left_join(out, by = "sciname") %>% 
  mutate(common = ifelse(is.na(common), common_fb, common)) %>% 
  dplyr::select(-common_fb)

iucn_spp_info <- taxa_cells_df %>%
  dplyr::select(iucn_sid, sciname, population, category) %>% 
  left_join(add_common, by = "sciname") %>% 
  distinct()

# write output to int folder
write.csv(iucn_spp_info, file.path(dir_goal, 'int/iucn_spp_info.csv'))
```


Some exploration of the species missing common names:  

```{r missing_spp_explore, eval = F}
scinames_explore <- miss_sp %>%
  separate(sciname, sep = " ", into = c("genus", "family")) %>% 
  group_by(genus) %>% 
  summarize(
    count = length(family)
  )
```

Looks like there are 20 genus' in the missing data, 9 of them have more than one species in the genus:   

 - `scinames_explore$genus[1]` are small polyp stony corals (5 species) 
 - `scinames_explore$genus[4]` are types of sea snails (43 species)   
 - `scinames_explore$genus[7]` are reef-building stony corals (4 species)  
 - `scinames_explore$genus[8]` are also stony corals (5 species)   
 - `scinames_explore$genus[12]` are sea cucumbers (15 species)     
 - `scinames_explore$genus[14]` are also reef-building stony corals (4 species)
 - `scinames_explore$genus[15]` are colonial stony corals (2 species)       
 - `scinames_explore$genus[16]` are Scleractinian corals (12 species)     
 - `scinames_explore$genus[17]` are also stony corals (5 species)  

## Calculate Species Scores

Add category weights to species list and calculate species status

```{r calc-spp-status, eval=F}
# Use iucn spp list
spp_info <- read_csv(file.path(dir_goal, 'int/iucn_spp_info.csv')) %>% 
  dplyr::select(-X1)

# Create category weights that will be used to calculate scores
pop_cat <- data.frame(category  = c("LC", "NT", "VU", "EN", "CR", "EX", "T", "CD", "NE", "DD"), 
                      cat_score = c(   0,  0.2,  0.4,  0.6,  0.8,  1.0, 0.6,  0.3,   NA,  NA),
                      stringsAsFactors = FALSE)

# Join category weights to species list
spp_status <- spp_info %>% 
  left_join(pop_cat, by = "category") %>% 
  filter(!is.na(cat_score)) %>%
  distinct() %>% 
  mutate(region_id = 1,
         status = (1 - cat_score)) %>% 
  dplyr::select(region_id, sciname, common, status)
```

 
Write out csv to the toolbox

```{r save-to-toolbox, eval = F}
# save to toolbox
dir_scores <- '~github/pal-scores/region'

#write_csv(spp_status, file.path(dir_scores, 'layers/spp_status.csv'))
```

# Species Marine Maps

Not sure if I still need this. 
Filter the list of IUCN marine maps from Casey's repo to just have the file paths for species in Palmyra
```{r spp-marine-maps, eval = F}
# Check for any subpopulations
spp_subpop <- iucn_spp_info %>% 
  filter(!is.na(population)) # one subpopulation for leatherbacks 'West Pacific Ocean subpopulation' 

spp_marine_maps <- read_csv("~/github/spp_risk_dists/_data/spp_marine_maps_2018-1.csv") %>%
  filter(sciname %in% iucn_spp_info$sciname, 
         subpop %in% c("West Pacific Ocean subpopulation", NA)) %>% 
  distinct()
# there are 414 maps which is more than the species list of 409

# Check for differences 
setdiff(spp_marine_maps$sciname, iucn_spp_info$sciname) # this shows no differences 
setdiff(iucn_spp_info$sciname, spp_marine_maps$sciname) # this gives 6 spp in the iucn list that are not in the maps list

# differences shows no marine map spp that aren't in the iucn dataset but the iucn dataset has less species than the map and I used distinct to make sure there aren't any duplicates 

# save
write.csv(spp_marine_maps, file.path(dir_github, 'prep/bd/spp/v2020/int/1_iucn_spp_shp_filepaths.csv'))
```

