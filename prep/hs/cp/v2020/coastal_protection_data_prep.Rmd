---
title: 'Coastal Protection Sub-goal'
subtitle: 'OHI+ Palmyra 2020 Assessment'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3 
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
     in_header: '~/github/pal-prep/src/templates/pal_hdr.html' 
  pdf_document:
    toc: true
---

# Summary 

This script calculates the status of coastal protection from coral reef habitats on Palmyra Atoll.  

# Data 

Coastal protection status is found using coral reef extent and condition.    

*Coral Reef Extent and Condition*   

Coral reef extent and condition data are the same data used in the coral habitat status layer. Coral cover maps were downloaded from the National Centers for Coastal Ocean Science (NCCOS) benthic habitat mapping project for Palmyra Atoll, found [here](https://products.coastalscience.noaa.gov/collections/benthic/e58palmyra/#horizontalTab3)   

Habitat maps were completed in December 2011 and data were downloaded on June 30, 2020.  

Citation: U.S. Department of Commerce, National Oceanic and Atmospheric Administration, National Center for Coastal Ocean Sciences. (2011). Palmyra Habitat Maps [Data file]. Retrieved from https://products.coastalscience.noaa.gov/collections/benthic/e58palmyra/     

# Setup 

```{r setup, message=F, warning=F, results='hide'}

library(tidyverse)
library(here)

# Source and set file paths
source(here('src/R/common.R'))

dir_goal   <- '~/github/pal-prep/prep/hs/cp/v2020' 
dir_hab    <- '~/github/pal-prep/prep/bd/hab/v2020'
```


# Methods 

## Coral Condition

Coral condition is the current condition of coral reef habitats relative to the reference point.   

$C_{condition}~=~C_{current}~/~C_{ref}$   

Where $C_{current}$ is the current status of coral habitats and $C_{ref}$ is the reference point of coral habitats. This is the same as the coral status calculated in the Biodiversity Habitats sub-goal.   

Use the coral status calculated in the Biodiversity: Habitats sub-goal.      

```{r coral-condition, eval=F}

hab_status <- read_csv(file.path(dir_hab, "output/coral_status.csv"))

# Find a single estimate of condition by averaging the status of each zone 
coral_condition <- hab_status %>% 
  group_by(region_id) %>% 
  summarize(value = weighted.mean(status, area_km)) %>% 
  mutate(dimension = "condition") %>% 
  dplyr::select(region_id, dimension, value)

# Save to int 
write_csv(coral_condition, file.path(dir_goal, "int/coral_condition.csv"))
```

## Coral Extent 

Use the coral extent calculated as parts of the Biodiversity: Habitats sub-goal.    

```{r coral-extent, eval=F}

# Use the extent calculated as part of the habitats sub-goal
coral_extent <- read_csv(file.path(dir_hab, "output/coral_extent.csv"))


# Save to int folder
write_csv(coral_extent, file.path(dir_goal, "int/coral_extent.csv"))
```

## Calculate Status

**Reference Point:** The coral condition will use the same reference points as the coral habitats sub-goal. 

 - Back Reef:  10-50%   
 - Reef Crest: 10-50%      
 - Fore Reef:  50-90%     
 - Lagoon:     10-50%    

The coastal protection status is calculated as the relative health of the habitats that provide coastal protection weighted by their area and protectiveness rank. Coral reefs are the only habitat included in the coastal protection goal for Palmyra, and the status is found by the following equation:  

$status~=~(C_{condition}~x~A~x~w)~/~(A~x~w)$   

Where $C_{condition}$ is the condition of coral habitats as defined above, $A$ is the area of coral reef habitat, and $w$ is the protectiveness rank for coral reefs. Coral reefs are the only habitat included in the coastal protection goal for Palmyra so there is no protectiveness rank and the area cancels out. Therefore, the current status for coastal protection is equivalent to the coral reef condition calculated in the Biodiversity Habitats sub-goal.   

```{r calculate-status, eval=F}
condition <- read_csv(file.path(dir_goal, "int/coral_condition.csv"))
extent    <- read_csv(file.path(dir_goal, "int/coral_extent.csv"))

# Assign values:
C <- condition$value
A <- extent$km2
w <- 3

# Define function to calculate the status 
status <- function(C,A,w) {
  (C * A * w) / (A * w)
}

# Find status - should be the same as the condition
# Area and weighting cancel out)
c_status <- status(C=C, A=A, w=w)   

# Create status data frame 
cp_status <- data.frame(
  region_id = 1,
  habitat = 'coral',
  year = 2011, 
  status = c_status
)

# Save to output
write_csv(cp_status, file.path(dir_goal, "output/cp_status.csv"))
```

## Save to Toolbox 

```{r save-to-toolbox, eval=F}
cp_status <- read_csv(file.path(dir_goal, "output/cp_status.csv"))
write_csv(cp_status, file.path(dir_scores, 'layers/hs_coastal_protection_status.csv'))
```

