---
title: 'OHI+ Palmyra 2020: Clean Waters Goal Soil Contamination Layer'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_depth: 3 
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
     in_header: '../../../src/templates/ohi_hdr.html' 
  pdf_document:
    toc: true
---

# Summary 

This script creates a dummy layer for soil contamination status. There is an ongoing study regarding soil contamination levels in Palmyra, but it will not be complete in time to be included in this assessment. Once the study is completed, that data can be substituted here to complete the Clean Waters goal.  

# Data

Include a description of the data, the date downloaded, and a link to the site where data can be accessed.   

Citation:   

# Setup 

```{r setup, message = F, warning = F}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(janitor)
library(lubridate)
library(here)

# Source and set file paths
source(here('src/R/common.R'))

dir_goal   <- '~/github/pal-prep/prep/cw/v2020'
dir_scores <- '~/github/pal-scores/region'
```


# Methods 

## Raw Data

Here you will read in the raw data from the study and wrangle it as necessary. You will most likely want to have a column listing each site (site), a column for the contaminant being measured (contaminant), and a column with the measured concentration (conc).  

To fill in the dummy layer we will assume there are three main contaminants evaluated in the study: contaminant 1 (C1), contaminant 2 (C2), and contaminant 3 (C3). We will assume there are five sites (S1-S5) around the island where soil samples were being taken (the actual number will likely vary). 

```{r raw-data, eval=F}

# Create dummy data - this will be substituted with actual data once the study is complete
contamination_raw <- data.frame(
  site = c("S1", "S1", "S1", "S2", "S2", "S2", "S3", "S3", "S3",
           "S4", "S4", "S4", "S5", "S5", "S5"),
  contaminant = c("C1", "C2", "C3", "C1", "C2", "C3", "C1", "C2", "C3",
                  "C1", "C2", "C3", "C1", "C2", "C3"),
  conc = runif(15, min = 0, max = .01) # level of contamination
)
```

## Add Reference Level

Each contaminant will have a unique reference point, a level of contamination that would be acceptable or a standard to which the soil should be remediated. 

Add the unique reference levels to the data set (the reference levels added below are made up).  

```{r add-reference-levels, eval=F}
# Define the reference points:
C1_ref <- 0.003
C2_ref <- 0.0004
C3_ref <- 0.0078

# Add the values to the raw data 
contaminants <- contamination_raw %>% 
  mutate(ref_level = case_when(contaminant == "C1" ~ C1_ref,
                               contaminant == "C2" ~ C2_ref,
                               contaminant == "C3" ~ C3_ref))
```


## Calculate Status

The status will be found for each contaminant and then the average of all the contaminants as defined by the following equations:  

$status_{c_{n},s}~=~(conc~/~ref_{level})$   

Where $status_{c_{n},s}$ is the status of each contaminant $c_{n}$ at site $s$. The $conc$ is the observed concentration of the contaminant and the $ref_{level}$ is the reference level concentration. These values are rescaled between 0-1 by dividing by the value corresponding to the 99th quantile (values > 1 are capped at 1).  

$status_{c_{n}}~=~mean(status_{c_{n},s})$  

Where $status_{c_{n}}$ is the status of contaminant $n$ found by averaging the status of the contaminant at every site $s$. 

$status~=~1~-~mean(status_{c_{n}})$ 

Where the overall status is the average of the status of each contaminant ($c_{n}$). Higher scores should be equated with lower levels of contamination, so the overall status is 1 minus the average contamination.  

```{r calculate-status, eval=F}

# Find the status of each contaminant
c_s_status <- contaminants %>% 
  mutate(cs_status = conc / ref_level)

# Find the 99th percentile value
rescale_value <- quantile(c_s_status$cs_status, probs = 0.99)

# Rescale the status of each contaminant 
contaminant_rescaled <- c_s_status %>% 
  mutate(cs_status = cs_status / rescale_value) %>% 
  mutate(cs_status = ifelse(cs_status > 1, 1, cs_status)) # cap values above 1 to 1

# Find the average of contaminants for all sites 
avg_contamination <- contaminant_rescaled %>% 
  group_by(contaminant) %>% 
  summarize(c_status = mean(cs_status))

# Find the overall status as 1 - average
status <- 1 - mean(avg_contamination$c_status)

## Create the final status data frame
## Need a region id, year, and status column 
contaminant_status <- data.frame(
  region_id = 1,
  year = 2020,
  status = status
)
```

## Save to Toolbox

*Not run for v2020*   

```{r save-to-toolbox, eval=F}
write_csv(contaminant_status, file.path(dir_scores, 'layers/cw_contaminant_status.csv'))
```






